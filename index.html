<html>
<head>
    <script src="static/interact-1.2.2.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link href="static/main.css" rel="stylesheet" type="text/css" />
<script>

var GUI = {};

GUI.Graph = function(parent, x, y, width, height, id) {
    this.id = id;
    var div = document.createElement('div');
    div.style.width = width;
    div.style.height = height;
    div.style.webkitTransform = 
        div.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
    div.setAttribute('data-x', x);
    div.setAttribute('data-y', y);
    
    div.classList.add('graph');
    
    div.gui_obj = this;
    
    this.div = div;
    interact(div)
        .draggable({
            inertia: true,
            restrict: {
                restriction: "parent",
                endOnly: true,
                elementRect: {top: 0, left: 0, bottom: 1, right: 1 }
            },
            onmove: function (event) {
                var target = event.target,
                    // keep the dragged position in the data-x/data-y attributes
                    x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
                    y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                // translate the element
                target.style.webkitTransform =
                    target.style.transform =
                    'translate(' + x + 'px, ' + y + 'px)';

                  // update the position attributes
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
            }
        })
        .resizable(true)
        .on('resizemove', function(event) {
            var target = event.target;

            // add the change in coords to the previous width of the target element
            var newWidth  = parseFloat(target.style.width ) + event.dx,
                newHeight = parseFloat(target.style.height) + event.dy;

            // update the element's style
            target.style.width  = newWidth + 'px';
            target.style.height = newHeight + 'px';
            
            // resize graph
            scale_x.range([0, newWidth]);
            scale_y.range([newHeight, 0]);
            var line = d3.svg.line()
                .x(function(d, i) {return scale_x(i);})
                .y(function(d) {return scale_y(d);})
            d3.select(target).select('path')
                .datum(data)
                .attr('d', line);
            
        });
    
    
    parent.appendChild(this.div);
    
    var svg = d3.select(div).append('svg')
        .attr('width', '100%')
        .attr('height', '100%');
        
    var scale_x = this.scale_x = d3.scale.linear();
    var scale_y = this.scale_y = d3.scale.linear();
    var line = d3.svg.line()
        .x(function(d, i) {return scale_x(i);})
        .y(function(d) {return scale_y(d);})
        
    var data = this.data = [];
    scale_x.domain([0, 6]);
    scale_y.domain([0, 20]);
    scale_x.range([0, width]);
    scale_y.range([height, 0]);
    

    svg.append('path')
        .datum(data)
        .attr('class', 'line')
        .attr('d', line);
    
    this.svg = svg;
    
    this.ws = new WebSocket('ws://localhost:8080/graph?id=' + id);
    this.ws.gui_obj = this;
    this.ws.onmessage = function(e) {
        data.push(parseFloat(e.data));
        if (data.length > 100) {
            data = data.slice(-100);
        }
        scale_x.domain([0, data.length - 1]);
        scale_y.domain([0, Math.max.apply(null, data)]);
        var line = d3.svg.line()
                .x(function(d, i) {return scale_x(i);})
                .y(function(d) {return scale_y(d);})
        d3.select(div).select('path')
                .datum(data)
                .attr('d', line);
        
    }
}


function onload() {
    main = document.getElementById("main")
    var g1 = GUI.Graph(main, 10, 20, 100, 100, 'a');
    var g2 = GUI.Graph(main, 50, 60, 100, 100, 'b');
    var g3 = GUI.Graph(main, 160, 60, 100, 100, 'c');
    var g4 = GUI.Graph(main, 250, 60, 100, 100, 'd');
}
</script>
</head>
<body onload="onload();">
<div id="main">

</div>
</body>
</html>